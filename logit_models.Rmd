---
title: "Logistic Model"
author: "Huanyu Chen, Shaolei Ma"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(foreign)
library(ggplot2)
library(MASS)
library(Hmisc)
library(reshape2)
library(car)

knitr::opts_chunk$set(
  fig.width = 8,
  fig.asp = .6,
  out.width = "90%",
  message = F,
  warning = F
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

The goal is to fit an ordered logit model.

## Independent Variables

First, test the distribution of independent variables.
```{r}
dass_new = read_csv("data/dass_new.csv")

dass_new |> 
  dplyr::select(age, everything()) |> 
  mutate(across(country:depression_level, factor)) |> 
  summary()
```

Some categories contain few samples. For the efficacy of the model, we regroup the independent variables following the standards below:

 * `country`: Group the country with less than 500 samples into "Other", and set "US" to be the reference level.
 * `education`: Order the variable by the length of education.
 * `race`: We follow [standards on race and ethnicity](https://www.govinfo.gov/content/pkg/FR-1997-10-30/pdf/97-28653.pdf) to include only "Asian", "Black", "Native American", "White", and make other categories "Other". We set "White" to be the reference level. 
 * `religion`: We conclude "Christian (Catholic)", "Christian (Mormon)", "Christian (Other)", "Christian (Protestant)" into "Christian", and set it as the reference level.
 * `orientation`: Set the "Heterosexual" to be the reference level.
 * `married`: Order the variable by marriage status.

```{r}
dass_fit_df =
  dass_new |> 
  mutate(
    country = relevel(as.factor(ifelse(country %in% c("MY", "US", "GB", "CA", "ID", "PH"), country, "Other")), ref = "US"),
    education = factor(education, levels = c("Less than high school", "High school", "University degree", "Graduate degree")),
    race = relevel(as.factor(ifelse(race %in% c("Arab", "Indigenous Australian"), "Other", race)), ref = "White"),
    religion = relevel(as.factor(ifelse(substr(religion, 1, 9) == "Christian", "Christian", religion)), "Christian"),
    orientation = relevel(as.factor(orientation), "Heterosexual"),
    married = factor(married, levels = c("Never married", "Currently married", "Previously married")),
    depression_level = factor(depression_level, levels = c("Normal", "Mild", "Moderate", "Severe", "Extremely severe"))
  )

dass_fit_df |> summary()
```

## Model Fitting

First fit a model without variables selection.
```{r}
dass_fit = 
  dass_fit_df |> 
  polr(depression_level ~ ., data = _)

(fit_s = 
  dass_fit |> 
  summary())
```

Test the parallel assumption.
```{r}
car::poTest(dass_fit)
```

Because the overall $p value < 0.001$, we reject the null hypothesis and conclude that the parallel assumption is not met.

To meet the parallel assumption, we try the following two methods:

 * **Select independent variables**: Because we think `religion` and `race`, `married` and `orientation`, `country` and `urban` are strongly correlated with each other, and we care more about `race`, `orientation`, and `country`, first delete `religion`, `married`, and `urban`. We also delete `education` to meet the parallel assumption.
 * **Regroup dependent variable**: Regroup `depression_level` into "Moderate or Below", "Severe", "Extremely severe".

```{r}
dass_fit_df =
  dass_fit_df |> 
  mutate(depression_level = factor(case_match(
    depression_level,
    "Normal" ~ "Moderate or Below",
    "Mild" ~ "Moderate or Below","Moderate" ~ "Moderate or Below",
    "Severe" ~ "Severe",
    "Extremely severe" ~ "Extremely severe"
   ), level = c("Moderate or Below", "Severe", "Extremely severe")))

dass_fit1 =
  dass_fit_df |> 
  polr(depression_level ~ country + gender + age + orientation + race, data = _)

dass_fit1 |> poTest()
```

The model meets the parallel assumption at $\alpha=0.05$ level (with an overall $p = 0.067 > 0.05$).

## Graphs Based On Current Regression Models
```{r}
library(pROC)

# Predicting probabilities for all classes
predicted_probs <- predict(dass_fit1, type = "probs")

# Extracting the response variable
response <- ifelse(dass_fit_df$depression_level == "Moderate or Below", 1,
                   ifelse(dass_fit_df$depression_level == "Severe", 2, 3))

# Calculating ROC curve for Severe (class 2)
roc_obj <- roc(as.numeric(response == 1), predicted_probs[, "Moderate or Below"])

# Plotting ROC curve
plot(roc_obj, col = "blue", main = "ROC Curve for Severe Depression Level")
```

```{r}
# Extract coefficients for countries
pos_country = str_starts(names(dass_fit1$coefficients), "country")

country_coefficients <- data.frame(
  country = substr(names(dass_fit1$coefficients)[pos_country], 8, 20),
  coefficient = dass_fit1$coefficients[pos_country]
)

# Plotting coefficients for countries
ggplot(country_coefficients, aes(x = country, y = coefficient)) +
  geom_bar(stat = "identity", fill = "skyblue", color = "black") +
  labs(title = "Effect of Countries on Depression Levels", x = "Country", y = "Coefficient")
```


```{r, fig.width=22, fig.height=53, message = FALSE}
library(effects)

# Create a data frame with the predictor values for visualization
predictor_data <- model.matrix(depression_level ~ country + gender + age + orientation + race, data = dass_fit_df)

# Compute the effects
effects <- allEffects(dass_fit1, xlevels = list(predictor_data))

# Plot the effects
plot(effects, style = "stacked")
```
